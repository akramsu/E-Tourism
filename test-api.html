<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - TourEase</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #e3f2fd; }
    </style>
</head>
<body>
    <h1>TourEase API Test</h1>
    <button onclick="testAuthority()">Test Authority APIs</button>
    <button onclick="testRevenue()">Test Revenue API Specifically</button>
    
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:5003';
        let authToken = null;

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
        }

        async function login() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'user18@example.com',
                        password: 'test123'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Login failed: ${response.status}`);
                }

                const data = await response.json();
                authToken = data.token;
                addResult(`‚úÖ Login successful. User: ${data.user.email} (${data.user.role.roleName})`, 'success');
                return true;
            } catch (error) {
                addResult(`‚ùå Login failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testEndpoint(name, url) {
            if (!authToken) {
                addResult(`‚ö†Ô∏è No auth token for ${name}`, 'error');
                return null;
            }

            try {
                const response = await fetch(`${API_BASE}${url}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                addResult(`‚úÖ ${name}: Success`, 'success');
                return data;
            } catch (error) {
                addResult(`‚ùå ${name}: ${error.message}`, 'error');
                return null;
            }
        }

        async function testRevenue() {
            addResult('üß™ Testing Revenue API specifically...', 'info');
            
            if (!authToken && !(await login())) {
                return;
            }

            const revenueData = await testEndpoint('Revenue API', '/api/authority/revenue?period=month&breakdown=category&includeComparisons=true');
            
            if (revenueData) {
                addResult(`üìä Revenue Data Structure:`, 'info');
                addResult(`- Success: ${revenueData.success}`, 'info');
                addResult(`- Data keys: ${Object.keys(revenueData.data || {}).join(', ')}`, 'info');
                addResult(`- topPerformer: ${JSON.stringify(revenueData.data?.topPerformer)}`, 'info');
                addResult(`- topPerformer.name: "${revenueData.data?.topPerformer?.name}"`, 'info');
                
                if (revenueData.data?.topPerformer?.name && revenueData.data.topPerformer.name !== 'N/A') {
                    addResult(`‚úÖ SUCCESS: Top performer name found: "${revenueData.data.topPerformer.name}"`, 'success');
                } else {
                    addResult(`‚ùå ISSUE: Top performer name is missing or N/A`, 'error');
                }
            }
        }

        async function testAuthority() {
            addResult('üß™ Starting Authority API Tests...', 'info');
            
            if (!authToken && !(await login())) {
                return;
            }

            const endpoints = [
                { name: 'City Metrics', url: '/api/authority/city-metrics?period=month&includeComparisons=true' },
                { name: 'Category Performance', url: '/api/authority/category-performance?period=month&includeComparisons=true' },
                { name: 'Tourism Insights', url: '/api/authority/tourism-insights?period=month&includeForecasts=true' },
                { name: 'Revenue Analysis', url: '/api/authority/revenue?period=month&breakdown=category&includeComparisons=true' },
                { name: 'Visitor Trends', url: '/api/authority/visitor-trends?period=month&groupBy=day&includeRevenue=true&includeComparisons=true' }
            ];

            let successCount = 0;
            let revenueData = null;

            for (const endpoint of endpoints) {
                const data = await testEndpoint(endpoint.name, endpoint.url);
                if (data) {
                    successCount++;
                    if (endpoint.name === 'Revenue Analysis') {
                        revenueData = data;
                    }
                }
            }

            addResult(`üìà Results: ${successCount}/${endpoints.length} endpoints successful`, successCount === endpoints.length ? 'success' : 'error');

            if (revenueData) {
                const topPerformerName = revenueData.data?.topPerformer?.name;
                addResult(`üéØ Revenue Analysis Details:`, 'info');
                addResult(`- Top Performer: ${JSON.stringify(revenueData.data?.topPerformer)}`, 'info');
                addResult(`- Will frontend get: "${topPerformerName || 'N/A'}"`, topPerformerName && topPerformerName !== 'N/A' ? 'success' : 'error');
            }

            if (successCount < endpoints.length) {
                addResult(`‚ö†Ô∏è Some endpoints failed - frontend might fall back to demo data with 'N/A' values`, 'error');
            }
        }
    </script>
</body>
</html>
